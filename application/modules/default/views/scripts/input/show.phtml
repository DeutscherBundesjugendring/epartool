<?php
    $supports = new Zend_Session_Namespace('supports');
    if (empty($supports->clicks)) {
        $supports->clicks = array();
    }
    $supportsDisabled = (
        Zend_Date::now()->isEarlier(new Zend_Date($this->consultation->spprt_fr, Zend_Date::ISO_8601))
        || Zend_Date::now()->isLater(new Zend_Date($this->consultation->spprt_to, Zend_Date::ISO_8601))
        || $this->consultation->spprt_fr == '0000-00-00 00:00:00'
        || $this->consultation->spprt_to == '0000-00-00 00:00:00'
        || $this->consultation->spprt_show == 'n'
    );
?>

<?php echo $this->secondNavigation('input'); ?>

<div class="main-content">
    <div class="row">
        <div class="sidebar-left">

            <?php echo $this->questionNavigation($this->question['qi']); ?>

        </div>
        <div class="content">

            <?php if (isset($this->tag) && !empty($this->tag)): ?>
                <?php if ($this->numberInputs > 0):?>
                    <h3><?=sprintf($this->translate('Only contributions with the keyword %s are shown.'), '<em>' . $this->tag['tg_de'] . '</em>')?></h3>
                <?php else: ?>
                    <h3><?=sprintf($this->translate('There are no contributions with the keyword %s on this question.'), '<em>' . $this->tag['tg_de'] . '</em>')?></h3>
                <?php endif; ?>
                <p>
                    <a href="<?php echo $this->url(array('tag' => null)); ?>">
                        <?=$this->translate('Show all contributions')?>
                    </a>
                </p>
            <?php endif; ?>
            <small class="count muted">
                <?php echo $this->numberInputs?>
                <?=$this->translate('Contributions')?>
            </small>

            <article class="articles">
                <h1><?php echo $this->question['nr'] . ' ' . $this->question['q']; ?></h1>
                <p><?php echo $this->question['q_xpl']; ?></p>
            </article>

            <!-- Contribution form -->
            <?php if (Zend_Date::now()->isEarlier(new Zend_Date($this->consultation->inp_fr, Zend_Date::ISO_8601))): ?>
                <p><?=$this->translate('Contribution phase has not started yet.')?></p>
            <?php elseif (Zend_Date::now()->isLater(new Zend_Date($this->consultation->inp_to, Zend_Date::ISO_8601))): ?>
                <p><?=$this->translate('Contribution phase is over already.')?></p>
            <?php else: ?>
                <?=$this->inputForm?>
            <?php endif?>

            <!-- Contributions -->
            <?php if (count($this->paginator)): ?>
                <?php
                // Reverse order of entries to show latest first
                $inputs = array();
                foreach ($this->paginator as $item) {
                    $inputs[] = $item;
                }
                $inputs = array_reverse($inputs);
                ?>
                <?php foreach ($inputs as $input): ?>
                    <a name="input-<?=$this->escape($input['tid']);?>"></a>
                    <article class="media">
                        <header class="article-header">
                            <time pubdate datetime="<?=$this->formatDate($input['when'], 'y-MM-dd') ?>">
                                <?=sprintf(
                                    $this->translate('written on %s'),
                                    $this->formatDate($input['when'], Zend_Date::DATE_MEDIUM)
                                )?>
                            </time>
                        </header>
                        <div class="article-body">
                            <p class="lead"><?=$this->escape($input['thes']);?></p>
                            <p><?=$this->escape($input['expl']);?></p>
                        </div>

                        <!-- Actions -->
                        <section class="article-actions">
                            <?php if ($this->consultation->spprt_show === 'y'): ?>
                                <span class="article-action" id="click-support-wrap-<?=$this->escape($input['tid']);?>">
                                    <?php if (in_array($input['tid'], $supports->clicks) || $supportsDisabled): ?>
                                        <span>
                                    <?php else: ?>
                                        <a
                                            href="#"
                                            id="click-support-<?=$this->escape($input['tid']);?>"
                                            class="click-support"
                                            rel="<?=$this->escape($input['tid']);?>"
                                        >
                                    <?php endif; ?>
                                            <i class="icon-ok-sign icon-orange icon-2x"></i>
                                            <span id="badge-<?=$this->escape($input['tid']);?>">(<?=$this->escape($input['spprts']);?>)</span>
                                    <?php if (in_array($input['tid'], $supports->clicks) || $supportsDisabled): ?>
                                            <span class="label"><?=$this->translate('supporters')?></span>
                                        </span>
                                    <?php else: ?>
                                            <span class="label"><?=$this->translate('I agree!')?></span>
                                        </a>
                                    <?php endif; ?>
                                </span>
                            <?php endif;?>

                            <?php if ($this->consultation->is_discussion_active): ?>
                                <span class="article-action">
                                    <i class="icon-comments icon-orange icon-2x"></i>
                                    <small>(<?=$this->escape($input['place']);?>)</small>
                                    <a class="label" href="<?=$this->baseUrl() . '/input/discussion/kid/' . $this->consultation->kid . '/inputId/' . $this->escape($input['tid']);?>">
                                        <?=$this->translate('I would like to discuss that!')?>
                                    </a>
                                </span>
                            <?php endif?>
                        </section><!-- .actions -->

                    </article>
                    <hr />
                <?php endforeach; ?>
            <?php endif; ?>

            <!-- Paging -->
            <?php echo $this->paginationControl(
                $this->paginator,
                'Sliding',
                '_partials/pagination.phtml',
                array('titlePrev' => $this->translate('Older contributions'), 'titleNext' => $this->translate('Newer contributions'))
            ); ?>

            <hr />

            <!-- Sign up -->
            <?=$this->subscriptionForm?>

        </div>
    </div><!-- .row -->

    <?=$this->render('_partials/pageLinks.phtml');?>

</div><!-- .main-content -->

<script type="text/javascript">
    $(document).ready(function() {

        // Toggle extended input
        $('.js-toggle-extended-input').click(function(event) {
            event.preventDefault();
            $(this).next('textarea').toggle();
            $(this).nextAll('.js-character-counter').toggle();
            $(this).toggleClass('expanded');

            if($(this).hasClass('expanded')) {
                $(this).html('<i class="icon-angle-up icon-large"></i> <?=$this->translate('shut again')?> <i class="icon-angle-up icon-large"></i>')
            } else {
                $(this).html('<i class="icon-angle-down icon-large"></i> <?=$this->translate('Click here to explain contribution')?> <i class="icon-angle-down icon-large"></i>')
            }
        });

        // Support a contribution
        $('.click-support').click(function(event) {
            event.preventDefault();
            var tid = $(this).attr('rel');
            $.post(
                "<?php echo $this->baseUrl(); ?>/input/support/kid/<?php echo $this->consultation->kid; ?>/format/json",
                { "tid": tid }
            ).done(function(data) {
                if (data.count) {
                    $('#click-support-wrap-' + tid).html('<span><i class="icon-ok-sign icon-orange icon-2x"></i>'
                        + ' <span id="badge-' + tid + '">(' + data.count + ')</span>'
                        + ' <span class="label"><?=$this->translate('supporters')?></span></span>');
                }
            });
        });

        $("#finish").click(function () {
            $("#submitmode").val('save_finish');
        });
        $("#plus").click(function () {
            $("#submitmode").val('save_plus');
        });
    });
</script>
