<?php foreach ($this->consultations as $consultation): ?>
    <?php
    // This should really be in model (w).
    $inputIsEnabled = false;
    $votingIsEnabled = false;
    $followupIsEnabled = false;
    $inputIsOpen = false;
    $votingIsOpen = false;

    // Phases are enabled.
    if (!(Zend_Date::now()->isEarlier($consultation->inp_fr) || $consultation->inp_fr == '0000-00-00 00:00:00')) {
        $inputIsEnabled = true;
    }

    if (!(Zend_Date::now()->isEarlier($consultation->vot_fr) || $consultation->vot_fr == '0000-00-00 00:00:00')) {
        $votingIsEnabled = true;
    }

    // Additionally disable voting back under certain conditions.
    if ($consultation->vot_to != '0000-00-00 00:00:00'
        && Zend_Date::now()->isLater(new Zend_Date($consultation->vot_to, Zend_Date::ISO_8601))
        && $consultation->vot_res_show == 'n'
    ) {
        $votingIsEnabled = false;
    }

    if (!(!Zend_Date::now()->isLater(new Zend_Date($consultation->vot_to, Zend_Date::ISO_8601))
        || $consultation->vot_to == '0000-00-00 00:00:00'
        || $consultation->follup_show == 'n')
    ) {
        $followupIsEnabled = true;
    }

    // Phases are now open.
    if (Zend_Date::now()->isLater(new Zend_Date($consultation->inp_fr, Zend_Date::ISO_8601))
        && Zend_Date::now()->isEarlier(new Zend_Date($consultation->inp_to, Zend_Date::ISO_8601))
    ) {
        $inputIsOpen = true;
    }

    if (Zend_Date::now()->isLater(new Zend_Date($consultation->vot_fr, Zend_Date::ISO_8601))
        && Zend_Date::now()->isEarlier(new Zend_Date($consultation->vot_to, Zend_Date::ISO_8601))
    ) {
        $votingIsOpen = true;
    }
    ?>

    <hr class="visible-print" />

    <!-- Consultation box -->
    <div class="consultation has-sticker">

        <!-- Heading -->
        <div class="row">
            <div class="col-sm-10 col-sm-offset-1">

                <a href="<?=$this->url(['controller' => 'article', 'action' => 'show', 'kid' => $consultation->kid]);?>" class="consultation-heading link-print-nourl">
                    <h2 class="consultation-heading-title">
                        <?=$this->escape($consultation->titl);?>
                    </h2>
                    <h3 class="consultation-heading-subtitle">
                        <?=$this->escape($consultation->titl_sub);?>
                    </h3>
                </a>

            </div>
        </div><!-- .row -->

        <!-- Sticker -->
        <?=$this->ribbonImage($consultation);?>

        <!-- Phases navigation -->
        <ul class="consultation-phases consultation-phases-preview">

            <!-- Title image with explanation -->
            <li class="hidden-print">
                <a href="<?=$this->url(['controller' => 'article', 'action' => 'show', 'kid' => $consultation->kid]);?>" class="consultation-phases-preview-image">
                    <img
                        src="<?=$this->baseUrl('www/media/' . Service_Media::MEDIA_DIR_CONSULTATIONS . '/' . $consultation->kid . $consultation->img_file);?>"
                        alt="<?=$this->escape($consultation->img_expl);?>"
                    />
                    <div class="consultation-phases-preview-image-description">
                        <p><?=nl2br($this->escape(strip_tags(htmlspecialchars_decode($consultation->expl_short))));?></p>
                    </div>
                </a>
            </li>

            <!-- Info -->
            <li>
                <a href="<?=$this->url(['controller' => 'article', 'action' => 'show', 'kid' => $consultation->kid]);?>" class="consultation-phases-item">
                    <h3 class="consultation-phases-item-title">
                        <?=$consultation->phase_info ? $this->escape($consultation->phase_info) : $this->translate('Info');?>
                    </h3>
                </a>
            </li>

            <!-- Questions -->
            <li>
                <a href="<?=$this->url(['controller' => 'question', 'action' => 'index', 'kid' => $consultation->kid]);?>" class="consultation-phases-item">
                    <h3 class="consultation-phases-item-title">
                        <?=$consultation->phase_support ? $this->escape($consultation->phase_support) : $this->translate('Questions');?>
                    </h3>
                </a>
            </li>

            <!-- Contributions -->
            <li>
                <?php if ($inputIsEnabled): ?>
                    <a href="<?=$this->url(['controller' => 'input', 'action' => 'index', 'kid' => $consultation->kid]);?>" class="consultation-phases-item">
                <?php else: ?>
                    <div class="consultation-phases-item disabled">
                <?php endif; ?>

                <h3 class="consultation-phases-item-title">
                    <?=$consultation->phase_input ? $this->escape($consultation->phase_input) : $this->translate('Contributions');?>
                </h3>

                <?php if ($consultation->inp_show == 'y' && $inputIsOpen): ?>
                    <div class="bubble bubble-lg consultation-phases-item-bubble hidden-print">
                        <h4 class="bubble-title"><?=$this->translate('Participate now!');?></h4>
                        <small>
                            <?=$this->translate('from');?>
                            <?=$this->formatDate($consultation->inp_fr, Zend_Date::DATE_MEDIUM);?><br />
                            <?=$this->translate('until');?>
                            <?=$this->formatDate($consultation->inp_to, Zend_Date::DATE_MEDIUM);?>
                        </small>
                    </div>
                <?php elseif ($consultation->inp_show == 'y'): ?>
                    <div class="consultation-phases-item-info">
                        <small>
                            <?=$this->translate('from');?>
                            <?=$this->formatDate($consultation->inp_fr, Zend_Date::DATE_MEDIUM);?><br />
                            <?=$this->translate('until');?>
                            <?=$this->formatDate($consultation->inp_to, Zend_Date::DATE_MEDIUM);?>
                        </small>
                    </div>
                <?php endif; ?>

                <?php if ($inputIsEnabled): ?>
                    </a>
                <?php else: ?>
                    </div>
                <?php endif; ?>
            </li>

            <!-- Voting -->
            <li>
                <?php if ($votingIsEnabled): ?>
                    <a href="<?=$this->url(['controller' => 'voting', 'action' => 'index', 'kid' => $consultation->kid]);?>" class="consultation-phases-item">
                <?php else: ?>
                    <div class="consultation-phases-item disabled">
                <?php endif;?>

                <h3 class="consultation-phases-item-title">
                    <?=$consultation->phase_voting ? $this->escape($consultation->phase_voting) : $this->translate('Voting');?>
                </h3>

                <?php if ($consultation->vot_show == 'y' && $votingIsOpen): ?>
                    <div class="bubble bubble-lg consultation-phases-item-bubble hidden-print">
                        <h4 class="bubble-title"><?=$this->translate('Vote now!');?></h4>
                        <small>
                            <?=$this->translate('from');?>
                            <?=$this->formatDate($consultation->vot_fr, Zend_Date::DATE_MEDIUM);?><br />
                            <?=$this->translate('until');?>
                            <?=$this->formatDate($consultation->vot_to, Zend_Date::DATE_MEDIUM);?>
                        </small>
                    </div>
                <?php elseif ($consultation->vot_show == 'y'): ?>
                    <div class="consultation-phases-item-info">
                        <small>
                            <?=$this->translate('from');?>
                            <?=$this->formatDate($consultation->vot_fr, Zend_Date::DATE_MEDIUM);?><br />
                            <?=$this->translate('until');?>
                            <?=$this->formatDate($consultation->vot_to, Zend_Date::DATE_MEDIUM);?>
                        </small>
                    </div>
                <?php endif; ?>

                <?php if ($votingIsEnabled): ?>
                    </a>
                <?php else: ?>
                    </div>
                <?php endif; ?>
            </li>

            <!-- Follow Up -->
            <?php if ($followupIsEnabled): ?>
                <li>
                    <a href="<?=$this->url(['controller' => 'followup', 'action' => 'index', 'kid' => $consultation->kid]);?>" class="consultation-phases-item">
                        <h3 class="consultation-phases-item-title">
                            <?=$consultation->phase_followup ? $this->escape($consultation->phase_followup) : $this->translate('Reactions & Impact');?>
                        </h3>
                    </a>
                </li>
            <?php else: ?>
                <li>
                    <div class="consultation-phases-item disabled">
                        <h3 class="consultation-phases-item-title">
                            <?=$consultation->phase_followup ? $this->escape($consultation->phase_followup) : $this->translate('Reactions & Impact');?>
                        </h3>
                    </div>
                </li>
            <?php endif; ?>

        </ul><!-- .consultation-phases -->
    </div><!-- .consultation -->

<?php endforeach; ?>
