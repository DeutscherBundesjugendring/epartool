<?php
    //$this->headLink()->appendStylesheet($this->baseUrl('css/vote.css'));
    $settings = $this->settings;
    $this->layout()->settings = $settings;
    $this->layout()->votingBasket= $this->votingBasket;
    $this->layout()->labels = $array = explode (',', $settings['btn_labels']);
?>

<script>
$(document).ready(function() {

	var elements = <?php echo $this->votingBasket['countvotes'];?>;

	$('a.view-basket').click(function() {
        $('div.vote-basket').slideToggle("slow");
    });
    $('a.close-basket').click(function() {
        $('div.vote-basket').slideToggle("slow");
    });
     $('a.close-basket-x').click(function() {
        $('div.vote-basket').slideToggle("slow");
    });

    $('a.view-basket-btn').click(function() {
        $('div.vote-basket').slideToggle("slow");
    });

    var superbtn = '<a href="<?=$this->url(array('controller' => 'voting', 'action' => 'thesissupervote', 'kid' => $this->consultation->kid))?>/tid/<?=$this->thesis['tid']?>/pts/y" class="voting-particularly-important" <?=$this->pimp == 'y' ? 'style="color: red!important"' : ''?>' +
        '<img src="<?=$this->baseUrl()?>/images/voting-rate-superbtn.png" alt="<?=$this->settings['btn_important_label']?>" title="<?=$this->settings['btn_important_label']?>" /><br />'+
        '<strong><?=$this->settings['btn_important_label']?> <span class="counter">(<?=$this->votingBasket['countvotes']?> <?=$this->translate('of')?> <?=$this->settings['btn_important_max']?>)</span></strong>'+
        '</a>';

	$(document).on("click", "a.voting-minus", function (event) {
            event.preventDefault();
            var elementID = $(this).attr('rel');

            $.ajax({
                url: "/voting/removethesis/kid/<?php echo $this->escape($this -> consultation -> kid); ?>/tid/"+elementID+"",
                type: "POST",
                data: "format=html",
                cache: false,
                async: "true",
                error: function(){
                    document.getElementById('voting-minus-'+elementID).innerHTML = "<?=$this->translate('Something went wrong');?>";
                },
                beforeSend: function(){
                    document.getElementById('voting-minus-'+elementID).innerHTML = '<img src="<?php echo $this->baseUrl(); ?>/images/ajax-loader.gif">';
                },
                success:function(response){
                    elements -= 1;
                    document.getElementById('voting-minus-'+elementID).innerHTML =  '<img src="<?php echo $this->baseUrl(); ?>/images/ajax-loader.gif">' ;
                    $( "a.view-basket-btn" ).replaceWith(superbtn);
                    $( "#thes-"+elementID).remove();
                    $( "span.counter-supervotes" ).html( elements+" von <?php echo $this->settings['btn_important_max'] ?>" );

                }
        });
        return false;
    });
 });
</script>

<?=$this->secondNavigation('voting');?>

<div class="main-content">

    <h1 class="text-center">
        <?=$this->translate('Voting for');?>
        &quot;<?=$this->consultation->titl;?>&quot;
    </h1>

    <div class="row">
        <div class="col-sm-12 col-md-10 col-md-offset-1">

            <?php if ($this->noMoreThesis): ?>

                <p>
                    <?=$this->translate('There are no more contributions to be voted in this category. Please switch to another questions or another keyword.');?>
                </p>

                <p>
                    <a href="<?= $this->url(['action' => 'overview', 'kid' => $this->consultation->kid], null, true);?>" class="btn btn-default">
                        <?=$this->translate('Change question or keyword');?>
                    </a>
                    <a href="<?=$this->url(['action' => 'stopvoting']);?>" class="btn btn-default" title="<?=$this->translate('Finish voting');?>">
                        <?=$this->translate('Finish');?>
                    </a>
                </p>

            <?php else: ?>

                <div id="vote" class="well well-bordered well-accent text-center has-sticker">

                    <!-- Sticker -->
                    <div class="sticker sticker-right hidden-print">
                        <div class="sticker-label sticker-label-dark">
                            <?=$this->translate('Join now!');?>
                        </div>
                    </div>

                    <!-- Vote basket -->
                    <?php if ($this->settings['btn_important'] == 'y'): ?>
                        <div class="vote-basket">
                        	<a class="close-basket-x" title="<?=$this->translate('hide');?>">x</a>
                            <h3>
                                <?=$this->translate('Decide what is most important!')?>
                                <span class="counter counter-supervotes">(<?php echo $this->votingBasket['countvotes']." von ".$this->settings['btn_important_max'];  ?>)</span>
                            </h3>
                            <p class="basket-info">
                                <?=$this->translate('The superbutton allows you to give certain contributions a higher vote. The overview shows you what you already marked as "especially important". Use the „–“ to reset your markings and allow space for more important contributions.')?>
                            </p>
                            <ul>
                                <?php  foreach ($this->votingBasket["votes"] as $v): ?>
                                    <li class="clearfix" id="thes-<?php echo $v["tid"]; ?>">
                                        <p> <?php echo $v["thes"]; ?></p>
                                        <a href="#" class="voting-minus" id="voting-minus-<?php echo $v["tid"]; ?>" title="entfernen" rel="<?php echo $v["tid"]; ?>">
                                            <img src="<?php echo $this->baseUrl(); ?>/images/voting-minus.png">
                                        </a>
                                    </li>
                                <?php endforeach?>
                            </ul>
                            <a class="close-basket"><?=$this->translate('hide')?></a>
                        </div>
                    <?php endif; ?>

                    <div class="row">
                        <div class="col-sm-4 text-left">

                            <!-- Counter -->
                            <div class="offset-bottom">
                                <?php
                                    // Add leading zeros to count voted
                                    $countTotal = $this->thesesCount;
                                    $countVoted = $this->thesesCountVoted;

                                    if (strlen($countTotal) > strlen($countVoted)) {
                                        $format = '%0' . strlen($countTotal) . 'd';
                                        $countVoted = sprintf($format, $countVoted);
                                    }

                                    // Print count voted by number
                                    $countVoted = str_split($countVoted);
                                    $countVotedText = '';

                                    foreach ($countVoted as $number) {
                                        $countVotedText .= '<span class="counter-digit">' . $number . '</span>';
                                    }

                                    $counter = '<span class="counter">' . $countVotedText . '</span>';
                                ?>
                                <?=sprintf($this->translate('You have voted on %s <br /> out of the total of %s contributions.'), $counter, $countTotal);?>
                            </div>

                        </div>
                        <div class="col-sm-4">

                            <h2 class="well-title offset-bottom-large"><?=$this->translate('Vote now!');?></h2>

                        </div>
                    </div><!-- .row -->

                    <!-- Question -->
                    <h3>
                        <?=$this->question['nr'];?>
                        <?=$this->question['q'];?>
                    </h3>
                    <?php if (!empty($this->thesis['tagname_de'])): ?>
                        <h4>
                            <?=$this->translate('Keyword');?>:
                            <?=$this->thesis['tagname_de'];?>
                        </h4>
                    <?php endif; ?>

                    <!-- Thesis -->
                    <div class="well well-simple text-left">
                        <?=$this->thesis['thes'];?>
                    </div>

                    <?php if (!empty($this->thesis['expl'])): ?>
                        <div class="well well-simple well-simple-alt">
                            <?=$this->escape($this->thesis['expl']);?>
                        </div>
                    <?php endif ?>

                    <!-- Rating bar -->
                    <div class="rating-bar">
                        <nav class="rating-bar-navigation">

                            <!-- Previous -->
                            <?php if (!empty($this->LastVote)): ?>
                                <?php if ($this->thesis['tid'] !== $this->LastVote[0]['tid']): ?>
                                    <a
                                        href="<?=$this->url(['kid' => $this->consultation->kid, 'tid' => $this->LastVote[0]['tid'], 'qid' => $this->LastVote[0]['qi']]);?>#vote"
                                        class="btn btn-inverse rating-bar-navigation-prev"
                                    >
                                        <span class="glyphicon glyphicon-menu-left icon-vertically-aligned" aria-hidden="true"></span>
                                        <span class="hidden-xs"><?=$this->translate('Undo');?></span>
                                    </a>
                                <?php endif; ?>
                            <?php endif; ?>

                            <p>
                                <strong>
                                    <?=$this->translate('How important is this contribution for further political discussions in your opinion?');?>
                                </strong>
                            </p>

                            <!-- Next -->
                            <a
                                href="<?=$this->url(['kid' => $this->consultation->kid, 'qid' => $this->question['qi'], 'token' => time()]);?>#vote"
                                class="btn btn-inverse rating-bar-navigation-next"
                            >
                                <span class="hidden-xs"><?=$this->translate('Skip');?></span>
                                <span class="glyphicon glyphicon-menu-right icon-vertically-aligned" aria-hidden="true"></span>
                            </a>

                        </nav>

                        <!-- Voting buttons -->
                        <?=$this->partial('_partials/voting/votingButtons.phtml', $this);?>

                    </div><!-- .rating-bar -->

                    <!-- Actions -->
                    <div class="form-group">
                        <a
                            href="<?=$this->url(['controller' => 'voting', 'action' => 'overview', 'kid' => $this->consultation->kid], null, true);?>"
                            id="buttonChangeKeyword"
                            class="btn btn-default btn-default-alt"
                        >
                            <?=$this->translate('Change question or keyword');?>
                        </a>
                    </div>
                    <div class="form-group">
                        <a href="<?=$this->url(['action' => 'stopvoting']);?>" class="btn btn-default btn-default-alt" title="<?=$this->translate('Finish voting');?>">
                            <span class="glyphicon glyphicon-log-out icon-offset" aria-hidden="true"></span>
                            <?=$this->translate('Finish');?>
                        </a>
                        <a href="<?$this->url(['action' => 'preview']);?>" class="btn btn-default btn-default-alt" title="<?=$this->translate('Preview voting');?>">
                            <span class="glyphicon glyphicon-eye-open icon-offset" aria-hidden="true"></span>
                            <?=$this->translate('Preview voting');?>
                        </a>
                    </div>

                </div><!-- .well -->

            <?php endif; ?>

        </div>
    </div><!-- .row -->

    <?=$this->partial('_partials/pageLinks.phtml', ['help' => 'help-text-consultation-voting']);?>

</div><!-- .main-content -->
