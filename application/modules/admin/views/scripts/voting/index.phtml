<section class="section-header">
    <div class="container">

        <?=$this->helpText('help-text-admin-consultation-voting-permissions');?>

        <h1 class="section-header-title"><?=$this->escape($this->consultation['titl']);?></h1>
        <h2 class="section-header-subtitle"><?=$this->escape($this->consultation['titl_sub']);?></h2>

        <?=$this->consultationTabs($this->consultation['kid'], 'consultation');?>

    </div>
</section>
<section class="section-content">
    <div class="container">
        <div class="row">
            <div class="sidebar offset-bottom-large-sm-max">

                <?=$this->consultationNavigation($this->consultation, 'voting-permissions');?>

            </div>
            <div class="content">

                <a class="btn btn-default pull-right" href="<?=$this->url(['action' => 'create-rights'])?>">
                    <span class="glyphicon glyphicon-plus-sign icon-shift-down offset-right" aria-hidden="true"></span>
                    <?=$this->translate('New Permission');?>
                </a>

                <?php if (!empty($this->votingRights)): ?>
                    <a
                        href="mailto:<?=$this->mailDefaultFrom;?>?bcc=<?=implode(';', array_filter(
                            array_map(function ($participant) {
                                return !empty($participant['email']) ? $participant['email'] : null;
                            }, $this->votingRights)
                        ));?>"
                        class="btn btn-default pull-right"
                    >
                        <span class="glyphicon glyphicon-pencil offset-right" aria-hidden="true"></span>
                        <?=$this->translate('Send an email to all');?>
                    </a>
                <?php endif;?>

                <h2><?=$this->translate('Voting Permissions');?></h2>

                <?php if ($this->countInserted): ?>
                    <p class="alert alert-info">
                        <span class="glyphicon glyphicon-info-sign icon-shift-down offset-right" aria-hidden="true"></span>
                        <strong><?=$this->countInserted;?></strong> <?=$this->translate('new users added recently.');?>
                    </p>
                <?php endif; ?>

                <?php if (!empty($this->votingRights)): ?>
                    <form method="<?=$this->listControlForm->getMethod();?>">
                        <?=$this->listControlForm->getElement($this->listControlForm->getCsrfTokenName());?>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th class="table-cell-id" data-toggle="sort" tabindex="0">#</th>
                                        <th class="sorting-asc" data-toggle="sort" tabindex="0"><?=$this->translate('User');?></th>
                                        <th data-toggle="sort" tabindex="0"><span class="text-wrap"><?=$this->translate('Voting Weight');?></span></th>
                                        <th data-toggle="sort" tabindex="0"><span class="text-wrap"><?=$this->translate('Access Code');?></span></th>
                                        <th data-toggle="sort" tabindex="0"><span class="text-wrap"><?=$this->translate('Accepted Size');?></span></th>
                                        <th data-toggle="sort" tabindex="0"><span class="text-wrap"><?=$this->translate('Stated Size');?></span></th>
                                        <th data-toggle="sort" tabindex="0"><span class="text-wrap"><?=$this->translate('Email');?></span></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($this->votingRights as $user): ?>
                                        <tr>
                                            <td class="table-cell-id"><?=$this->escape($user['uid']);?></td>
                                            <td>
                                                <?php if ($user['name']): ?>
                                                    <?=$this->escape($user['name']);?>
                                                <?php elseif ($user['name_group']): ?>
                                                    <?=$this->escape($user['name_group']);?>
                                                <?php elseif ($user['name_pers']): ?>
                                                    <?=$this->escape($user['name_pers']);?>
                                                <?php else: ?>
                                                    <?=$this->escape(mb_substr($user['email'], 0, mb_stripos($user['email'], '@')));?>
                                                <?php endif; ?>
                                                <?php if ($user['invitation_sent_date'] !== null): ?>
                                                    <i class="glyphicon glyphicon-ok" style="color: green;" aria-hidden="true"></i>
                                                <?php endif; ?>
                                            </td>
                                            <td><?=$this->escape($user['vt_weight']);?></td>
                                            <td><?=$this->escape($user['vt_code']);?></td>
                                            <td><?=$this->escape($user['grp_siz']);?></td>
                                            <td><?=$this->escape($user['group_size_user'] ? $user['group_size_user'] : '-');?></td>
                                            <td>
                                                <a href="mailto:<?=$this->escape($user['email']);?>">
                                                    <?=$this->escape($user['email']);?>
                                                </a>
                                            </td>
                                            <td class="table-cell-actions">
                                                <a
                                                    href="<?=$this->url(['controller' => 'input', 'action' => 'list-by-user', 'uid' => $user['uid']]);?>"
                                                    class="item-action"
                                                    title="<?=$this->translate('Show all contributions by this user');?>"
                                                >
                                                    <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
                                                </a>
                                                <a
                                                    href="<?=$this->url(['action' => 'editrights', 'uid' => $user['uid']]);?>"
                                                    class="item-action"
                                                    title="<?=$this->translate('Edit permissions');?>"
                                                >
                                                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                                </a>
                                                <?php if (!empty($user['email'])): ?>
                                                    <a
                                                        href="<?=$this->url(['action' => 'sendinvitation', 'uid' => $user['uid'], 'mode' => 'preview']);?>"
                                                        class="item-action"
                                                        title="<?=$this->translate('Preview and send invitation');?>"
                                                    >
                                                        <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>
                                                    </a>

                                                    <?php if ($user['invitation_sent_date'] !== null): ?>
                                                        <button
                                                            value="<?=$this->escape($user['uid']);?>"
                                                            name="instantSendUserId"
                                                            class="item-action has-badge"
                                                            data-toggle="confirm"
                                                            data-confirm-message="<?=$this->translate('Do you really want to send invitation to this user again?');?>"
                                                            data-confirm-yes="<?=$this->translate('Yes');?>"
                                                            data-confirm-no="<?=$this->translate('No');?>"
                                                            title="<?=sprintf($this->translate('Invitation has been sent at %s'), $this->formatDate($user['invitation_sent_date']));?>"
                                                        >
                                                            <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                                                        </button>
                                                    <?php else: ?>
                                                        <button
                                                            value="<?=$this->escape($user['uid']);?>"
                                                            name="instantSendUserId"
                                                            class="item-action"
                                                            data-toggle="confirm"
                                                            data-confirm-message="<?=$this->translate('Do you really want to send invitation to this user?');?>"
                                                            data-confirm-yes="<?=$this->translate('Yes');?>"
                                                            data-confirm-no="<?=$this->translate('No');?>"
                                                            title="<?=$this->translate('Send invitation');?>"
                                                        >
                                                            <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                                                        </button>
                                                    <?php endif; ?>
                                                <?php endif; ?>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </form>
                <?php else: ?>
                    <p class="alert alert-info">
                        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
                        <?=$this->translate('There are no permissions to be set.');?>
                    </p>
                <?php endif; ?>

            </div>
        </div>
    </div>
</section>
